[platformio]
default_envs = esp32_usb

; =============================================================================
; Common settings for all ESP32 builds
; =============================================================================
[common]
monitor_speed = 115200

build_unflags =
    -std=gnu++11
    -std=c++11
    -std=gnu++14
    -std=c++14

build_flags =
    -std=gnu++17
    -DCORE_DEBUG_LEVEL=0
    -DENABLE_DEBUG_LOGS=0
    ; Size optimization
    -Os
    -ffunction-sections
    -fdata-sections
    -fno-exceptions
    -fno-rtti
    -fno-threadsafe-statics
    -fmerge-all-constants
    ; Linker optimizations
    -Wl,--gc-sections
    ; ArduinoJson optimizations
    -DARDUINOJSON_ENABLE_PROGMEM=1
    -DARDUINOJSON_ENABLE_COMMENTS=0
    -DARDUINOJSON_ENABLE_NAN=0
    -DARDUINOJSON_ENABLE_INFINITY=0
    -DARDUINOJSON_DECODE_UNICODE=0
    -DARDUINOJSON_STRING_LENGTH_SIZE=1

lib_deps_base =
    bblanchon/ArduinoJson @ ^7.0.0

; =============================================================================
; Feature Flag Presets
; Each preset defines which features are enabled for different use cases
; =============================================================================

; --- MINIMAL: UART only, basic telemetry, smallest flash footprint ---
[flags:minimal]
build_flags =
    ; Transport
    -DHAS_WIFI=0
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=1
    -DHAS_MQTT_TRANSPORT=0
    ; Motors
    -DHAS_SERVO=0
    -DHAS_STEPPER=0
    -DHAS_DC_MOTOR=0
    -DHAS_ENCODER=0
    -DHAS_MOTION_CONTROLLER=0
    ; Sensors
    -DHAS_ULTRASONIC=0
    -DHAS_IMU=0
    -DHAS_LIDAR=0
    ; Control
    -DHAS_SIGNAL_BUS=0
    -DHAS_CONTROL_KERNEL=0
    -DHAS_OBSERVER=0
    -DHAS_CONTROL_MODULE=0
    ; System
    -DHAS_OTA=0
    -DHAS_TELEMETRY=1
    -DHAS_HEARTBEAT=1
    -DHAS_LOGGING=0
    -DHAS_IDENTITY=0
    ; Audio
    -DHAS_AUDIO=0

; --- MOTORS: Motor control without network (UART only) ---
[flags:motors]
build_flags =
    ; Transport
    -DHAS_WIFI=0
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=1
    -DHAS_MQTT_TRANSPORT=0
    ; Motors - ALL ENABLED
    -DHAS_SERVO=1
    -DHAS_STEPPER=1
    -DHAS_DC_MOTOR=1
    -DHAS_ENCODER=1
    -DHAS_MOTION_CONTROLLER=1
    ; Sensors - minimal
    -DHAS_ULTRASONIC=0
    -DHAS_IMU=0
    -DHAS_LIDAR=0
    ; Control
    -DHAS_SIGNAL_BUS=0
    -DHAS_CONTROL_KERNEL=0
    -DHAS_OBSERVER=0
    -DHAS_CONTROL_MODULE=0
    ; System
    -DHAS_OTA=0
    -DHAS_TELEMETRY=1
    -DHAS_HEARTBEAT=1
    -DHAS_LOGGING=1
    -DHAS_IDENTITY=0
    ; Audio
    -DHAS_AUDIO=0

; --- SENSORS: WiFi + all sensors, no motors (data collection) ---
[flags:sensors]
build_flags =
    ; Transport
    -DHAS_WIFI=1
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=1
    -DHAS_MQTT_TRANSPORT=0
    ; Motors - disabled
    -DHAS_SERVO=0
    -DHAS_STEPPER=0
    -DHAS_DC_MOTOR=0
    -DHAS_ENCODER=0
    -DHAS_MOTION_CONTROLLER=0
    ; Sensors - ALL ENABLED
    -DHAS_ULTRASONIC=1
    -DHAS_IMU=1
    -DHAS_LIDAR=1
    ; Control
    -DHAS_SIGNAL_BUS=0
    -DHAS_CONTROL_KERNEL=0
    -DHAS_OBSERVER=0
    -DHAS_CONTROL_MODULE=0
    ; System
    -DHAS_OTA=1
    -DHAS_TELEMETRY=1
    -DHAS_HEARTBEAT=1
    -DHAS_LOGGING=1
    -DHAS_IDENTITY=1
    ; Audio
    -DHAS_AUDIO=0

; --- CONTROL: Full control system with motors and core sensors ---
[flags:control]
build_flags =
    ; Transport
    -DHAS_WIFI=1
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=1
    -DHAS_MQTT_TRANSPORT=0
    ; Motors - ALL ENABLED
    -DHAS_SERVO=1
    -DHAS_STEPPER=1
    -DHAS_DC_MOTOR=1
    -DHAS_ENCODER=1
    -DHAS_MOTION_CONTROLLER=1
    ; Sensors - core only
    -DHAS_ULTRASONIC=0
    -DHAS_IMU=1
    -DHAS_LIDAR=0
    ; Control - ALL ENABLED
    -DHAS_SIGNAL_BUS=1
    -DHAS_CONTROL_KERNEL=1
    -DHAS_PID_CONTROLLER=1
    -DHAS_STATE_SPACE=1
    -DHAS_OBSERVER=1
    -DHAS_CONTROL_MODULE=1
    ; System
    -DHAS_OTA=1
    -DHAS_TELEMETRY=1
    -DHAS_HEARTBEAT=1
    -DHAS_LOGGING=1
    -DHAS_IDENTITY=1
    ; Audio
    -DHAS_AUDIO=0

; --- FULL: All features enabled (current default) ---
[flags:full]
build_flags =
    ; Transport
    -DHAS_WIFI=1
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=1
    -DHAS_MQTT_TRANSPORT=0
    ; Motors - ALL ENABLED
    -DHAS_SERVO=1
    -DHAS_STEPPER=1
    -DHAS_DC_MOTOR=1
    -DHAS_ENCODER=1
    -DHAS_MOTION_CONTROLLER=1
    ; Sensors - ALL ENABLED
    -DHAS_ULTRASONIC=1
    -DHAS_IMU=1
    -DHAS_LIDAR=1
    ; Control - ALL ENABLED
    -DHAS_SIGNAL_BUS=1
    -DHAS_CONTROL_KERNEL=1
    -DHAS_PID_CONTROLLER=1
    -DHAS_STATE_SPACE=1
    -DHAS_OBSERVER=1
    -DHAS_CONTROL_MODULE=1
    ; System
    -DHAS_OTA=1
    -DHAS_TELEMETRY=1
    -DHAS_HEARTBEAT=1
    -DHAS_LOGGING=1
    -DHAS_IDENTITY=1
    ; Audio
    -DHAS_AUDIO=0

; =============================================================================
; ESP32 Base Environment
; =============================================================================
[env:esp32_base]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = ${common.monitor_speed}
build_unflags = ${common.build_unflags}
board_build.partitions = partitions_ota_big.csv
board_upload.maximum_size = 1917952

; =============================================================================
; Build Profiles - Choose based on your use case
; =============================================================================

; MINIMAL BUILD (~350KB) - UART only, basic telemetry
[env:esp32_minimal]
extends = env:esp32_base
build_flags =
    ${common.build_flags}
    ${flags:minimal.build_flags}
lib_deps = ${common.lib_deps_base}

; MOTORS BUILD (~550KB) - Motor control without network
[env:esp32_motors]
extends = env:esp32_base
build_flags =
    ${common.build_flags}
    ${flags:motors.build_flags}
lib_deps =
    ${common.lib_deps_base}
    ESP32Servo

; SENSORS BUILD (~600KB) - WiFi + all sensors, data collection
[env:esp32_sensors]
extends = env:esp32_base
build_flags =
    ${common.build_flags}
    ${flags:sensors.build_flags}
lib_deps =
    ${common.lib_deps_base}
    pololu/VL53L0X@^1.3.1

; CONTROL BUILD (~750KB) - Full control system with motors
[env:esp32_control]
extends = env:esp32_base
build_flags =
    ${common.build_flags}
    ${flags:control.build_flags}
lib_deps =
    ${common.lib_deps_base}
    ESP32Servo

; FULL BUILD (~870KB) - Everything enabled
[env:esp32_full]
extends = env:esp32_base
build_flags =
    ${common.build_flags}
    ${flags:full.build_flags}
lib_deps =
    ${common.lib_deps_base}
    ESP32Servo
    pololu/VL53L0X@^1.3.1
    knolleary/PubSubClient@^2.8

; =============================================================================
; Development Environments (extend full for USB/OTA upload)
; =============================================================================
[env:esp32_usb]
extends = env:esp32_full
upload_protocol = esptool
upload_port = /dev/tty.usbserial-0001
monitor_port = /dev/tty.usbserial-0001

[env:esp32_ota]
extends = env:esp32_full
upload_protocol = espota
upload_port = ESP32-bot.local
upload_flags = --port=3232

; =============================================================================
; Native Host Tests (platform = native, no hardware)
; =============================================================================
[env:native]
platform = native
test_framework = unity

test_build_src = false

build_flags =
    -std=gnu++17
    -DUNIT_TEST=1
    -Itest/fakes
    -include test/fakes/Arduino.h
    -include test/fakes/DebugMacros.h
    ; Disable hardware-dependent features for native tests
    -DHAS_WIFI=0
    -DHAS_BLE=0
    -DHAS_UART_TRANSPORT=0
    -DHAS_SERVO=0
    -DHAS_STEPPER=0
    -DHAS_DC_MOTOR=0
    -DHAS_ENCODER=0
    -DHAS_IMU=0
    -DHAS_LIDAR=0
    -DHAS_ULTRASONIC=0
    -DHAS_OTA=0
    -DHAS_SIGNAL_BUS=1
    -DHAS_CONTROL_KERNEL=1
    -DHAS_OBSERVER=1

lib_deps =
    bblanchon/ArduinoJson @ ^7.0.0

test_filter =
    test_protocol*
    test_event_bus*
    test_messages_json*
    test_command_handler_ack*
    test_safety*
    test_identity_version_handshake*
